<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">
<head>
  <title>iHerb 상품 간단 테이블</title>
  <meta charset="UTF-8"/>
</head>
<body>
<button onclick="fetchProducts()">상품링크 불러오기</button>

<table id="productTable" border="1">
  <thead>
  <tr>
    <th>대표이미지</th>
    <th>상품ID</th>
    <th>제품명</th>
    <th>구매가</th>
  </tr>
  </thead>
  <<tbody id="tbodyArea">
    <tr>
      <td colspan="4">상품이 없습니다</td>
    </tr>
  </tbody>
</table>

<script>
  function fetchProducts() {
    // 1. 상품 ID Array GET (예시)
    fetch('/enroll/fetch-iherb-links')
      .then(res => res.json()) // body를 한번만 읽음!
      .then(ids => {
        console.log(ids); // 상품 ID 배열 로그

        // 2. 상품정보 POST로 조회
        fetch('/crawl/iherb/list/simple', {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify(ids)  // 배열 그대로 POST!
        })
          .then(res => {
            if (!res.ok) throw new Error("상품정보 조회 실패(" + res.status + ")");
            return res.json();      // 여기서도 body 한 번만 읽기!
          })
          .then(productList => {
            renderTable(productList);
          })
          .catch(err => {
            console.error("상품정보 호출 오류:", err);
          });
      })
      .catch(err => {
        console.error("ID 목록 불러오기 오류:", err);
      });
  }
  // 3. 결과표 렌더링 (JS 동적 생성)
  function renderTable(productList) {
    let html = "";
    if (productList && productList.length > 0) {
      productList.forEach(item => {
        html += "<tr>";
        html += `<td><img src="${item.campaignImage}" alt="대표이미지" style="height:60px;"/></td>`;
        html += `<td>${item.id}</td>`;
        html += `<td>${item.displayName}</td>`;
        html += `<td>${item.discountPriceAmount}</td>`;
        html += "</tr>";
      });
    } else {
      html = '<tr><td colspan="4">상품이 없습니다</td></tr>';
    }
    document.getElementById("tbodyArea").innerHTML = html;
  }
</script>
</body>
</html>
